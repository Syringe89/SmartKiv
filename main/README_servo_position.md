# Модуль чтения положения сервопривода для ESP32-H2

## Описание
Модуль обеспечивает чтение аналогового сигнала с сервопривода, который выдает напряжение в диапазоне 0-4.2В, пропорциональное положению вала. Модуль использует ADC (аналого-цифровой преобразователь) ESP32-H2 для преобразования аналогового напряжения в цифровую форму, после чего производит пересчет в угол положения вала.

## Особенности
- Работа с аналоговым сигналом 0-4.2В через делитель напряжения
- Настраиваемая калибровка для соответствия напряжения и угла положения
- Возможность получения как сырых значений ADC, так и калиброванных значений напряжения и угла
- Экономное использование ресурсов (один канал ADC)
- Поддержка режима "oneshot" для минимизации энергопотребления
- Встроенная поддержка делителя напряжения для безопасной работы с напряжениями выше 3.3В
- Управление питанием схемы считывания через GPIO для дополнительной экономии энергии

## Аппаратное подключение
Сигнальный провод с сервопривода подключается к аналоговому входу ESP32-H2 через делитель напряжения. По умолчанию используется GPIO3 (ADC1, канал 3) для считывания сигнала и GPIO4 для активации схемы считывания.

```
Сервопривод  ->  Делитель напряжения  ->  ESP32-H2
Сигнал (0-4.2В) -> [R1 -> ADC вход -> R2 -> GND] -> GPIO3 (ADC_CHANNEL_3)

ESP32-H2 GPIO4 -> Схема активации считывания
```

## Схема активации считывания
Для экономии энергии модуль поддерживает активацию/деактивацию схемы считывания положения через управляющий GPIO. 

Типичные схемы активации:
1. **Прямое управление питанием** - GPIO управляет транзистором или реле, которое подает питание на схему считывания
2. **Управление через линию Enable** - GPIO подключается к линии активации датчика положения
3. **Управление через мультиплексор** - GPIO управляет мультиплексором для подключения сигнала к АЦП

## Делитель напряжения
Поскольку максимальное входное напряжение для ADC ESP32-H2 составляет 3.3В (в режиме аттенюации 12dB), а сервопривод может выдавать напряжение до 4.2В, необходимо использовать делитель напряжения для безопасной работы.

Рекомендуемая схема делителя:
- Резистор R1 = 10 кОм (подключается к выходу сервопривода)
- Резистор R2 = 15 кОм (подключается к земле)
- Средняя точка соединения R1 и R2 подключается к ADC входу ESP32-H2

Такой делитель преобразует входное напряжение 4.2В в напряжение около 2.5В на входе ADC, что является безопасным уровнем.

Формула для расчета коэффициента делителя: `voltage_divider_factor = (R1 + R2) / R2`
Для указанных значений: (10кОм + 15кОм) / 15кОм = 1.67

## Конфигурация
Перед использованием модуля необходимо его настроить. Настройки включают в себя:

1. Минимальный и максимальный углы вращения сервопривода
2. Напряжение, соответствующее минимальному углу
3. Напряжение, соответствующее максимальному углу
4. Параметры делителя напряжения (если используется)
5. Параметры пина активации схемы считывания (если используется)

## API модуля

### Инициализация
```c
esp_err_t servo_position_reader_init(servo_position_reader_config_t *config);
```
Инициализирует модуль с заданными параметрами калибровки.

### Управление схемой считывания
```c
esp_err_t servo_position_set_reading_enabled(bool enabled);
```
Включает или выключает схему считывания. Если `enabled = true`, включает схему; если `enabled = false`, выключает схему.

### Чтение положения
```c
esp_err_t servo_position_reader_get_angle(float *angle);
```
Читает текущее положение сервопривода в градусах. Автоматически активирует схему считывания, если необходимо.

### Чтение напряжения
```c
esp_err_t servo_position_reader_get_voltage_mv(float *voltage_mv);
```
Читает текущее напряжение с сервопривода в милливольтах. Учитывает делитель напряжения, если он настроен.

### Чтение сырого значения ADC
```c
esp_err_t servo_position_reader_get_raw(int *raw_value);
```
Читает сырое значение ADC (0-4095). Автоматически активирует схему считывания, если необходимо.

### Деинициализация
```c
esp_err_t servo_position_reader_deinit(void);
```
Освобождает ресурсы, используемые модулем.

## Пример использования

```c
// Инициализация модуля
servo_position_reader_config_t config = {
    .angle_min = 0.0f,          // Минимальный угол сервопривода (0 градусов)
    .angle_max = 180.0f,        // Максимальный угол сервопривода (180 градусов)
    .voltage_min = 0.0f,        // Напряжение при минимальном угле (мВ)
    .voltage_max = 4200.0f,     // Напряжение при максимальном угле (мВ)
    
    // Настройка делителя напряжения для безопасной работы с 4.2В
    .use_voltage_divider = true,
    .voltage_divider_factor = 1.67f,  // Для делителя R1=10кОм, R2=15кОм: (10+15)/15=1.67
    
    // Настройка пина активации схемы считывания
    .use_enable_pin = true,           // Использовать пин для активации
    .enable_pin = 4,                  // GPIO4 для активации (SERVO_POSITION_ENABLE_PIN)
    .enable_level = true              // Активация при HIGH уровне
};

esp_err_t ret = servo_position_reader_init(&config);
if (ret != ESP_OK) {
    // Обработка ошибки
}

// Активация схемы считывания перед чтением
servo_position_set_reading_enabled(true);

// Чтение угла сервопривода
float angle;
ret = servo_position_reader_get_angle(&angle);
if (ret == ESP_OK) {
    printf("Угол сервопривода: %.2f градусов\n", angle);
}

// Деактивация схемы считывания для экономии энергии
servo_position_set_reading_enabled(false);

// Для одиночного считывания можно не вызывать функцию активации явно,
// функции чтения автоматически управляют активацией при необходимости
float voltage_mv;
ret = servo_position_reader_get_voltage_mv(&voltage_mv);
if (ret == ESP_OK) {
    printf("Напряжение сервопривода: %.2f мВ (%.2f В)\n", 
            voltage_mv, voltage_mv/1000.0f);
}

// Деинициализация при завершении работы
servo_position_reader_deinit();
```

## Режимы работы с питанием

Модуль поддерживает несколько режимов работы с питанием:

1. **Постоянное питание** - Схема считывания активна всегда
   - Установите `use_enable_pin = false`
   - Подходит для случаев, когда энергопотребление не критично

2. **Управляемое питание** - Питание включается только для считывания
   - Установите `use_enable_pin = true`
   - Включайте/выключайте вручную через `servo_position_set_reading_enabled(true)` и `servo_position_set_reading_enabled(false)`
   - Идеально для экономии энергии в приложениях с батарейным питанием

3. **Автоматическое управление** - Питание автоматически активируется при считывании
   - Установите `use_enable_pin = true`
   - Просто вызывайте функции чтения - питание будет включаться/выключаться автоматически
   - Удобно для простых приложений с периодическим считыванием

## Ограничения
1. ADC ESP32-H2 имеет некоторую нелинейность, что может повлиять на точность измерений.
2. Для более точных измерений рекомендуется выполнить индивидуальную калибровку для конкретного сервопривода.
3. Максимальное входное напряжение для ADC ESP32-H2 составляет 3.3В (в режиме аттенюации 12dB), поэтому необходимо использовать делитель напряжения для измерения напряжений до 4.2В.

## Формулы для расчетов

### Расчет коэффициента делителя напряжения
```
voltage_divider_factor = (R1 + R2) / R2
```

### Расчет реального напряжения по измеренному значению ADC
```
actual_voltage = adc_voltage * voltage_divider_factor
```

### Перевод напряжения в положение сервопривода (угол)
```
angle = angle_min + (voltage - voltage_min) * (angle_max - angle_min) / (voltage_max - voltage_min)
``` 
# Схема подключения сервопривода к ESP32-H2

## Базовая схема подключения

Для безопасного считывания напряжения с сервопривода (диапазон 0-4.2В) к ESP32-H2 (максимальное входное напряжение ADC 3.3В) необходимо использовать делитель напряжения.

```
                          R1 (10 кОм)
Сервопривод (0-4.2В) -----/\/\/\------+
                                       |
                                       |
                                       +------- ADC вход ESP32-H2 (GPIO3)
                                       |
                                       |
                                       +
                          R2 (15 кОм)  |
                              /\/\/\   |
                                       |
                                       |
GND -------------------------------+---+
                                   |
                                   |
ESP32-H2 GND --------------------+
```

## Расчет делителя напряжения

Для делителя напряжения с R1=10 кОм и R2=15 кОм:

1. Коэффициент деления: R2 / (R1 + R2) = 15 / (10 + 15) = 15 / 25 = 0.6
2. Максимальное входное напряжение: 4.2В
3. Максимальное напряжение на ADC входе: 4.2В × 0.6 = 2.52В

Это напряжение безопасно для ADC ESP32-H2, которое может измерять напряжения до 3.3В.

## Коэффициент для преобразования в программе

Для получения исходного напряжения сервопривода из измеренного ADC значения используется обратный коэффициент:
- voltage_divider_factor = (R1 + R2) / R2 = (10 + 15) / 15 = 25 / 15 = 1.67

## Схема с управлением питанием

Для экономии энергии рекомендуется добавить схему управления питанием цепи считывания положения. Для этого можно использовать один из вариантов:

### Вариант 1: Управление через N-канальный MOSFET

```
Питание сервопривода
+5В -------------------------+
                            |
                            |
                     +------+------+
                     |             |
                     | Сервопривод |  
                     |             |
                     +------+------+
                            |
                            |
GND -----------------------+
                            |
              Выход         |
              положения     |
              (0-4.2В)      |
                            |
                            +----+
                                 |
                                 |
                      R1 (10 кОм)|
                           /\/\/\|
                                 |
                                 +------- ADC вход ESP32-H2 (GPIO3)
                                 |
                                 |
                    R2 (15 кОм)  |
                        /\/\/\   |
                                 |
                                 |
GND ------------------------+----+
                            |
                            |
                            |    +----+
                            |    |    |
                            |    |    |
                            |    |    | BS170 или
                            |    |    S аналогичный
                            +----+D   | N-канальный MOSFET
                                 |    |
                                 |    |
                                 +----+
                                 |    |
                                 |   G|
                                 |    |
                                 |    +---- 1кОм ------ ESP32-H2 GPIO4
                                 |
                                 |
ESP32-H2 GND -----------------+
```

### Вариант 2: Управление через P-канальный MOSFET

```
                                     
Питание сервопривода                    
+5В -----------------+----------------------------------+
                     |                                  |
                     |                                  |
                     |              +----+              |
                     |              |    |              |
                     |              |    |              |
                     |              |    | AO3401 или   |
                     |              |    S аналогичный  |
                     |              +--D-+ P-канальный  |
                     |                 |  | MOSFET      |
                     |                 |  |             |
                     |                 |  |             |
                     |                 | G|             |
                     |                 |  |             |
                     |                 |  +-- 10кОм --- GND
                     |                 |  |              
                     |                 |  +------------ ESP32-H2 GPIO4
                     |                 |  
              +------+------+          |  
              |             |          |  
              | Сервопривод |          |  
              |             |          |  
              +------+------+          |  
                     |                 |  
                     |                 |  
GND --------------+  |                 |  
                  |  |                 |  
       Выход      |  |                 |  
       положения  |  |                 |  
       (0-4.2В)   |  |                 |  
                  |  |                 |  
                  |  +--------+        |  
                  |           |        |  
                  |           |        |  
                  |  R1 (10 кОм)       |  
                  |        /\/\/\      |  
                  |           |        |  
                  |           +--------+------ ADC вход ESP32-H2 (GPIO3)
                  |           |           
                  |           |           
                  | R2 (15 кОм)           
                  |     /\/\/\            
                  |           |           
                  |           |           
GND --------------+-----------+           
                  |                       
                  |                       
ESP32-H2 GND ---+                        
```

## Общая схема подключения с управлением питанием

```
+--------------+             +-------------------+
|              |             |                   |
|  Сервопривод |             |     ESP32-H2      |
|              |             |                   |
+-+-----+------+             +--+----+-------+--+
  |     |                       |    |       |
  |     |                       |    |       |
  |     |                       |    |       |
GND  Сигнал                    GND  GPIO3   GPIO4
      |                               |       |
      |                               |       |
      |                               |       |
      |  +------+                     |       |
      +--| Дел. |---------------------+       |
         |напр. |                             |
         +--+---+                             |
            |                                 |
            |           +--------------------+
            |           |
            |        +--+---+
            +--------| Схема |
                     |питания|
                     +------+
```

## Рекомендации

1. Используйте резисторы с точностью 1% или лучше для обеспечения точности измерений.
2. Разместите делитель напряжения как можно ближе к входу ADC для уменьшения шумов.
3. При необходимости добавьте керамический конденсатор 0.1 мкФ параллельно R2 для фильтрации шумов.
4. Проверьте фактические напряжения на входе ADC с помощью мультиметра и при необходимости скорректируйте программные коэффициенты.
5. Учтите, что сигнальный провод сервопривода может быть длинным, что может привести к падению напряжения и наводкам. В таком случае рекомендуется использовать экранированный кабель.
6. Для схемы с управлением питанием убедитесь, что схема стабилизируется до начала измерения (в программе используется задержка POSITION_READING_STABILIZATION_TIME_MS мс). 